<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
  <head>
    <title>Tests for guards.js</title>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.11.0.css" type="text/css" media="screen" />
    <script type="text/javascript" src="http://code.jquery.com/qunit/qunit-1.11.0.js"></script>
    <script type="text/javascript" src="blanket.js"></script>

    <script>
      var JQUERY_VERSIONS = ["1.4.4", "1.5.2", "1.6.4", "1.7.2", "1.8.3", "1.9.1", "1.10.1", "2.0.2"];
      var DEFAULT_JQUERY_VERSION = "1.10.1";
      QUnit.config.jquery = QUnit.urlParams.jquery || DEFAULT_JQUERY_VERSION;

      function loadScript(url, callback, enableCoverage) {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = url;

        if (enableCoverage) {
          script.setAttribute("data-cover", "true");
        }

        if (callback) {
          script.onload = callback;
        }

        var before = document.getElementsByTagName("script")[0];
        before.parentNode.insertBefore(script, before);
      }

      loadScript("http://ajax.googleapis.com/ajax/libs/jquery/" + QUnit.config.jquery + "/jquery.js", function() {
        loadScript("../src/guards.js", scriptsReady, true);
      });

      function scriptsReady() {
        QUnit.config.urlConfig.push({
          id: "nonstop",
          label: "Non-stop",
          tooltip: "Continue until a failure or the last jQuery version in the list."
        });

        if (QUnit.urlParams.nonstop) {
          QUnit.done(function(details) {
            if (details.failed > 0) {
              return;
            }

            var nextJqueryIndex = JQUERY_VERSIONS.indexOf(QUnit.config.jquery) + 1;

            // This shouldn't really happen unless the url is manually changed
            if (nextJqueryIndex <= 0) {
              return;
            }

            if (nextJqueryIndex >= JQUERY_VERSIONS.length) {
              return;
            }

            window.location = QUnit.url({ jquery: JQUERY_VERSIONS[nextJqueryIndex] });
          });
        }

        $(document).bind("DOMSubtreeModified", function() {
          if ($("#qunit #jquery-version").size() > 0) {
            return;
          }

          if ($("#qunit #qunit-testrunner-toolbar").size() == 0) {
            return;
          }

          var $jQueryVersion = $('<label for="jquery-version">jQuery Version: </label><select id="jquery-version" name="jquery"></select>');

          $.each(JQUERY_VERSIONS, function(i, version) {
            $jQueryVersion.append('<option value="' + version + '">' + version + '</option>');
          });

          $jQueryVersion.val(QUnit.config.jquery);

          $jQueryVersion.change(function() {
            var jqueryValue = $(this).val();

            if (jqueryValue == DEFAULT_JQUERY_VERSION) {
              jqueryValue = undefined;
            }

            window.location = QUnit.url({ jquery: jqueryValue });
          });

          $("#qunit-testrunner-toolbar").prepend($jQueryVersion);
        });

        $(function() {
          $.guards.on("form", "submit", function(e) {
            e.preventDefault();
          });

          function resetGuards() {
            $.guards = new $.Guards();
          }

          function errorMsgClass() {
            return $.guards.defaults.messageClass;
          }

          function invalidClass() {
            return $.guards.defaults.invalidClass;
          }

          function errorTag() {
            return $.guards.defaults.tag;
          }

          function assertGuards(options) {
            options.expectedErrorCount = options.expectedErrorCount || 0;
            options.expectedErrorMessageCount = options.expectedErrorMessageCount || 0;
            var form = options.form;

            if (!options.skipInvokeGuard) {
              equal($(form).guard(), options.expectedToPass, "Form guards should fail");
            }

            equal($(form + " :has-error").size(), options.expectedErrorCount, "Number of fields with errors");
            equal($(form + " ." + errorMsgClass()).size(), options.expectedErrorMessageCount, "Error message count");
            if (options.errorMessageLocations) {
              $.each(options.errorMessageLocations, function(i, x) {
                var errorMsg = $(form + " ." + errorMsgClass()).eq(i);
                var expectedMsg = options.errorMessages;

                if ($.isArray(expectedMsg)) {
                  expectedMsg = expectedMsg[i];
                }

                equal($(x)[0], errorMsg.prev()[0], "An error message should be located after");
                equal(errorMsg.html(), expectedMsg, "The correct error message should be used");
              });
            }
          }

          function equalArray(array, expected, message) {
            if (message) {
              message = message + ": ";
            } else {
              message = "";
            }

            equal(array.length, expected.length, message + "array length");

            for (var i = 0; i < array.length; i++) {
              equal(array[i], expected[i], message + "array item at index " + i);
            }
          }

          function okRegex(regex, string, message) {
            message = message || ("\"" + string + "\" matches " + regex);
            ok(regex.test(string), message);
          }

          function notOkRegex(regex, string, message) {
            message = message || ("\"" + string + "\" doesn't match " + regex);
            ok(!regex.test(string), message);
          }

          // Thanks to http://stackoverflow.com/questions/3561493/is-there-a-regexp-escape-function-in-javascript/3561711#3561711
          RegExp.escape = function(value) {
            return value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&");
          };

          function okStyle(selector, attr, value, html) {
            var message = "style:\n" + html + "\nshould have '" + selector + "' with style '" + attr + ": " + value + "'";
            okRegex(new RegExp(RegExp.escape(selector) + "\\s*\\{[^}]*" + RegExp.escape(attr) + ":\\s*" + RegExp.escape(value) + ";[^}]*\\}"), html, message);
          }

          function notOkStyle(selector, attr, value, html) {
            var message = "style:\n" + html + "\nshould not have '" + selector + "' with style '" + attr + ": " + value + "'";
            notOkRegex(new RegExp(RegExp.escape(selector) + "\\s*\\{[^}]*" + RegExp.escape(attr) + ":\\s*" + RegExp.escape(value) + ";[^}]*\\}"), html, message);
          }

          function generateTest(options, args, fn) {
            var testName = options.testName;

            if (!testName) {
              var valuesMessage = $.map(args, function(val, i) {
                return "'" + val + "'";
              }).join(", ");

              testName = "with " + valuesMessage + " entered";
            }

            test(testName, function() {
              $.each(args, function(i, value) {
                $("#form1-" + (i + 1)).val(value);
              });

              assertGuards(fn());
            });
          }

          function successTest() {
            var args = $.makeArray(arguments);
            var generateOptions = {};

            if (args.length > 0 && typeof(args[args.length - 1]) != "string") {
              generateOptions = args.pop();
            }

            generateTest(generateOptions, args, function() {
              return {
                form: "#form1",
                expectedToPass: true
              };
            });
          }

          function failureTest() {
            var args = $.makeArray(arguments);
            var options = args.pop();
            var generateOptions = { testName: options.testName };

            generateTest(generateOptions, args, function() {
              if (options.errorMessageSelector) {
                options.errorMessageLocations = $(options.errorMessageSelector);
              }

              return $.extend({
                form: "#form1",
                expectedToPass: false,
                expectedErrorCount: 1,
                expectedErrorMessageCount: 1,
                errorMessageLocations: $("#form1-1"),
                errorMessages: "An error has occurred."
              }, options);
            });
          }

          function isOldJquery(oldVersions) {
            return oldVersions.indexOf(QUnit.config.jquery) >= 0;
          }

          function jQueryTooOld(name) {
            test(name, function() {
              ok(false, "jQuery is too old for this test.");
            });
          }

          function jQueryNot(options, fn) {
            if (isOldJquery(options.unsupportedVersions)) {
              jQueryTooOld(options.name);
            } else {
              fn();
            }
          }

          function testJQueryNot(options, fn) {
            jQueryNot(options, function() {
              test(options.name, fn);
            });
          }

          module("discovered bugs", { setup: resetGuards });

          test("#13: grouped guards with no form", function() {
            $.guard("#form8 input[type='text']").using("different");

            // Via guard
            $("#form8").guard();
            assertGuards({
              skipInvokeGuard: true,
              form: "#form8",
              expectedToPass: false,
              expectedErrorCount: 4,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form8-4"),
              errorMessages: "These values must all be different."
            });

            // Via live guard
            $("#form8 :has-error").clearErrors();
            $.liveGuard("#form8");
            $("#form8-1").blur();
            assertGuards({
              skipInvokeGuard: true,
              form: "#form8",
              expectedToPass: false,
              expectedErrorCount: 4,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form8-4"),
              errorMessages: "These values must all be different."
            });
          });

          test("#13: radio button with no form", function() {
            $.guard("#form8 input:radio").using("required");
            $("#form8").guard();
            assertGuards({
              skipInvokeGuard: true,
              form: "#form8",
              expectedToPass: false,
              expectedErrorCount: 3,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form8-7"),
              errorMessages: "This field is required."
            });
          });

          test("#13: radio button custom guard value with no form", function() {
            var values = [];
            $.guard("#form8 input:radio").using(function(v, e) {
              values.push(v);
              return true;
            });
            $("#form8-6").attr("checked", "checked");
            $("#form8").guard();
            equal(values.length, 3, "Values length");
            equal(values[0], "2", "First value");
            equal(values[1], "2", "Second value");
            equal(values[2], "2", "Third value");
          });

          test("#13: radio button custom grouped guard value with no form", function() {
            var values = [];
            $.guard("#form8 input:radio").grouped().using(function(v, e) {
              values.push(v);
              return true;
            });
            $("#form8-6").attr("checked", "checked");
            $("#form8").guard();
            equal(values.length, 1, "Result length");
            equal(values[0].length, 3, "Result[0] length");
            equal(values[0][0], "2", "First value");
            equal(values[0][1], "2", "Second value");
            equal(values[0][2], "2", "Third value");
          });

          module("guardable fields", { setup: resetGuards });

          test("without options", function() {
            var results = $("#form1, #form2 input").guardableFields();
            equal(results.size(), 4, "Result size");
            equal(results[0], $("#form1-1")[0], "First element");
            equal(results[1], $("#form1-2")[0], "Second element");
            equal(results[2], $("#form1-3")[0], "Third element");
            equal(results[3], $("#form1-4")[0], "Fourth element");
          });

          test("selector without tag", function() {
            var results = $("#form1 :guardable");
            equal(results.size(), 4, "Result size");
            equal(results[0], $("#form1-1")[0], "First element");
            equal(results[1], $("#form1-2")[0], "Second element");
            equal(results[2], $("#form1-3")[0], "Third element");
            equal(results[3], $("#form1-4")[0], "Fourth element");
          });

          test("selector with tag", function() {
            var results = $("#form1 input:guardable");
            equal(results.size(), 4, "Result size");
            equal(results[0], $("#form1-1")[0], "First element");
            equal(results[1], $("#form1-2")[0], "Second element");
            equal(results[2], $("#form1-3")[0], "Third element");
            equal(results[3], $("#form1-4")[0], "Fourth element");
          });

          test("buttons", function() {
            var results = $("#form9 :guardable");
            equal(results.size(), 2, "Result size");
            equal(results[0], $("#form9-1")[0], "First element");
            equal(results[1], $("#form9-2")[0], "Second element");
          });

          module("general guards", { setup: function() {
            resetGuards();
            $.guard("input").using("required");
          } });

          test("using standard guard that doesn't exist", function() {
            throws(function() {
              $.guard("input").using("foobar");
            }, /There is no named guard 'foobar'/, "Non-existant standard guard throws an error");
          });

          test("version is specified", function() {
            ok($.guard.version, "There is a version specified using $.guard.version");
            ok($.guards.version, "There is a version specified using $.guards.version");
            equal($.guards.version, $.guard.version, "$.guard.version is the same as $.guards.version");
          });

          test("errors don't stack", function() {
            $.guard("input").using("required");
            $("#form1").guard();
            equal($("#form1 ." + errorMsgClass()).size(), $("#form1 input").size(), "Error msg count");
          });

          test("errors stack if the option is enabled", function() {
            $.guard("input").using("required");
            $.guards.options.stackErrors = true;
            $("#form1").guard();
            equal($("#form1 ." + errorMsgClass()).size(), $("#form1 input").size() * 2, "Error msg count");
            equal($("#form1-1").errors().length, 2, "Error count on a single element");
          });

          test("clearing a stacked error won't remove the other error", function() {
            $.guard("input").using("required");
            $.guards.options.stackErrors = true;
            $("#form1").guard();
            $("#form1-1").errors()[0].clear();
            equal($("#form1 ." + errorMsgClass()).size(), $("#form1 input").size() * 2 - 1, "Error msg count");
            equal($("#form1 :has-error").size(), $("#form1 input").size(), "Field error count");
            equal($("#form1-1").errors().length, 1, "Error count on a single element");
            ok($("#form1-1").hasClass(invalidClass()), "Single element has error class still");
          });

          test("clearing a stacked error with a different class won't remove the other error", function() {
            $.guard("input").using("required").invalidClass("my-invalid");
            $.guards.options.stackErrors = true;
            $("#form1").guard();
            $("#form1-1").errors()[0].clear();
            equal($("#form1 ." + errorMsgClass()).size(), $("#form1 input").size() * 2 - 1, "Error msg count");
            equal($("#form1 :has-error").size(), $("#form1 input").size(), "Field error count");
            equal($("#form1-1").errors().length, 1, "Error count on a single element");
            ok(!$("#form1-1").hasClass(invalidClass()), "Single element doesn't have the default invalid error anymore");
            ok($("#form1-1").hasClass("my-invalid"), "Single element has the custom invalid error class");
          });

          test("multiple stacked errors show in defined order", function() {
            $.guard("input").using("required").message("This is the second error.");
            $.guard("input").using("required").message("This is the third error.");
            $.guards.options.stackErrors = true;
            $("#form1").guard();
            var $errors = $("#form1 .error-message");
            equal($errors.eq(0).text(), "This field is required.", "The first error message");
            equal($errors.eq(1).text(), "This is the second error.", "The second error message");
            equal($errors.eq(2).text(), "This is the third error.", "The third error message");
          });

          test("enabled guards can be removed", function() {
            $("#form1").submit();
            equal($("#form1 :has-error").size(), 0, "Errors after submitting");
            $("#form1").enableGuards();
            $("#form1").submit();
            equal($("#form1 :has-error").size(), 4, "Errors after submitting");
            $("#form1 :has-error").clearErrors();
            $("#form1").disableGuards();
            $("#form1").submit();
            equal($("#form1 :has-error").size(), 0, "Errors after submitting");
          });

          test("enabled delegated guards can be removed", function() {
            $("#form1").submit();
            equal($("#form1 :has-error").size(), 0, "Errors after submitting");
            $.enableGuards("#form1");
            $("#form1").submit();
            equal($("#form1 :has-error").size(), 4, "Errors after submitting");
            $("#form1 :has-error").clearErrors();
            $.disableGuards("#form1");
            $("#form1").submit();
            equal($("#form1 :has-error").size(), 0, "Errors after submitting");
          });

          test("separate Guards instances with separate defaults both work at the same time", function() {
            var other = new $.Guards();
            other.constants.notChecked = "bad";
            other.defaults.messageClass = "my-message";
            other.defaults.invalidClass = "my-invalid";
            other.defaults.tag = "p";
            other.add("input").using(function(value, element) { return $.inArray(value, ["bad", "invalid"]) == -1; });
            $("#form2").guard();
            ok($("#form2-3").hasClass(invalidClass()), "Invalid class exists for $.guards");
            ok($("#form2-3").next().hasClass(errorMsgClass()), "Error message class exists for $.guards");
            ok($("#form2-3").next().is("span"), "Error message is a span for $.guards");
            $("#form2 input").clearErrors();
            other.guard($("#form2"));
            ok($("#form2-3").hasClass("my-invalid"), "Invalid class exists for custom guards");
            ok($("#form2-3").next().hasClass("my-message"), "Error message class exists for custom guards");
            ok($("#form2-3").next().is("p"), "Error message is a p for custom guards");
          });

          test("overriding default target works", function() {
            var other = new $.Guards();
            other.constants.notChecked = "bad";
            other.defaults.target = "#form1-customTarget-before";
            other.add("input[name='group1']").using(function(value, element) { return $.inArray(value, ["bad", "invalid"]) == -1; }).message("My error message.");
            other.guard($("#form2"));
            equal($("#form1-customTarget-before").text(), "My error message.", "The error message shows up with a custom default target");
          });

          test("separate Guards can have separate defaults", function() {
            $.guards.defaults.guard = "oneRequired";
            var other = new $.Guards();
            equal($.guards.defaults.guard, "oneRequired", "Default guard");
            equal(other.defaults.guard, "required", "Other default guard");
          });

          test("only affects the form being guarded", function() {
            $("#form1").guard();
            equal($("#form1 input:has-error").size(), $("#form1 input").size(), "Form 1 error count");
            equal($("#form2 input:has-error").size(), 0, "Form 2 error count");
          });

          test("focuses the first visible errored element", function() {
            var received = false;
            $("#form1-1").hide();
            $("#form1-2").val("A value");
            $("#form1-3").focus(function() { received = true; });
            $("#form1").guard();
            equal(received, true, "The third field is focused");
            equal($("#form1 input:has-error").size(), $("#form1 input").size() - 1, "Error count");
          });

          test("removes the field's error when a keyup is detected", function() {
            $("#form1-2").val("A value");
            $("#form1").guard();
            equal($("#form1 input:has-error").size(), $("#form1 input").size() - 1, "Error count before keyup");
            $("#form1-1").keydown();
            $("#form1-1").keyup();
            equal($("#form1-1").errors().length, 0, "Keyuped input's error count");
            equal($("#form1 input:has-error").size(), $("#form1 input").size() - 2, "Error count after keyup");
          });

          test("keyup doesn't remove the field's error when a keydown triggered the guard", function() {
            $("#form1-2").val("A value");
            equal($("#form1-1").errors().length, 0, "Keyuped input's error count");
            $("#form1-1").keydown();
            $("#form1").guard();
            equal($("#form1-1").errors().length, 1, "Before keyup input error count");
            $("#form1-1").keyup();
            equal($("#form1-1").errors().length, 1, "After keyup input error count");
            $("#form1-1").keydown();
            $("#form1-1").keyup();
            equal($("#form1-1").errors().length, 0, "After second keyup input error count");

            $("#form1-1").keydown();
            $("#form1").guard();
            equal($("#form1-1").errors().length, 1, "Before keyup input error count");
            $("#form1-1").keyup();
            equal($("#form1-1").errors().length, 1, "After keyup input error count");
            $("#form1-1").keydown();
            $("#form1-1").keyup();
            equal($("#form1-1").errors().length, 0, "After second keyup input error count");
          });

          test("errors can be manually triggered from an element", function() {
            var guard = $.guard("input").using("required");
            equal($("#form1 input").errors().length, 0, "There are 0 errors before doing anything");
            $("#form1-1, #form1-2").triggerError(guard);
            equal($("#form1 input").errors().length, 2, "There are 2 errors after triggering a manual error");
          });

          test("errors can be manually triggered from a guard", function() {
            var guard = $.guard("input").using("required");
            equal($("#form1 input").errors().length, 0, "There are 0 errors before doing anything");
            guard.triggerError("#form1-1, #form1-2");
            equal($("#form1 input").errors().length, 2, "There are 2 errors after triggering a manual error");
          });

          test("errors can be manually triggered from a guard with no arguments", function() {
            var guard = $.guard("#form1-1, #form1-3").using("required");
            equal($("#form1 :has-error").size(), 0, "There are 0 errors before doing anything");
            guard.triggerError();
            equal($("#form1 :has-error").size(), 2, "There are 2 errors after triggering a manual error");
            ok($("#form1-1:has-error, #form1-3:has-error").size() === 2, "The right elements have the error");
          });

          test("manually triggered errors can't double up", function() {
            var guard = $.guard("input").using("required");
            equal($("#form1 input").errors().length, 0, "There are 0 errors before doing anything");
            guard.triggerError("#form1-1, #form1-2");
            guard.triggerError("#form1-1, #form1-2");
            equal($("#form1 input").errors().length, 2, "There are 2 errors after triggering a manual error");
          });

          test("manually triggered grouped errors can't double up", function() {
            var guard = $.guard("input").using("oneRequired");
            equal($("#form1 input").errors().length, 0, "There are 0 errors before doing anything");
            guard.triggerError("#form1 input");
            equal($("#form1 input").errors().length, 4, "There are 4 errors after triggering the first manual grouped error");
            equal($("#form1 .error-message").size(), 1, "There is 1 error message after triggering the first manual grouped error");
            guard.triggerError("#form1 input");
            equal($("#form1 input").errors().length, 4, "There are 4 errors after triggering the second manual grouped error");
            equal($("#form1 .error-message").size(), 1, "There is 1 error message after triggering the second manual grouped error");
          });

          module("named guards", { setup: resetGuards });

          test("works with simple setup", function() {
            $.guards.name("testing").using(function(value) { return value === "testing"; }).message("It wasn't 'testing'");
            $.guard("#form1 input").using("testing");
            $("#form1-2").val("testing");
            $("#form1").guard();
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: 3,
              expectedErrorMessageCount: 3,
              errorMessageLocations: $("#form1-1,#form1-3,#form1-4"),
              errorMessages: "It wasn't 'testing'"
            });
          });

          test("includes the name on guards that use it", function() {
            $.guards.name("testing").using(function(value) { return value === "testing"; }).message("It wasn't 'testing'");
            equal($.guard("#form1 input").using("testing").name, "testing", "Guard name");
          });

          module("guard events", { setup: resetGuards });

          test("guard error", function() {
            var events = [];
            $("form input").bind("guardError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 3, "Number of events fired");
          });

          test("grouped guard error", function() {
            var events = [];
            $("form input").bind("guardError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 3, "Number of events fired");
          });

          test("guard form error", function() {
            var events = [];
            $("form").bind("guardFormError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 3, "Number of events fired");
          });

          test("grouped guard form error", function() {
            var events = [];
            $("form").bind("guardFormError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 1, "Number of events fired");
          });

          test("after guard error", function() {
            var events = [];
            $("form input").bind("afterGuardError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 3, "Number of events fired");
          });

          test("after grouped guard error", function() {
            var events = [];
            $("form input").bind("afterGuardError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 3, "Number of events fired");
          });

          test("after guard form error", function() {
            var events = [];
            $("form").bind("afterGuardFormError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 3, "Number of events fired");
          });

          test("after grouped guard form error", function() {
            var events = [];
            $("form").bind("afterGuardFormError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 1, "Number of events fired");
          });

          test("guard error can prevent default", function() {
            var guardFormErrorTriggered = false;
            $("#form1").bind("guardFormError", function(e) { guardFormErrorTriggered = true; });
            $("#form1-1").bind("guardError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1-1").using("required");
            $("#form1").guard();
            equal($(":has-error").size(), 0, "Errors after default prevented");
            ok(guardFormErrorTriggered, "guardFormError is still triggered");
          });

          test("grouped guard error can prevent default", function() {
            var guardFormErrorTriggered = false;
            $("#form1").bind("guardFormError", function(e) { guardFormErrorTriggered = true; });
            $("#form1-1").bind("guardError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            equal($(":has-error").size(), 0, "Errors after default prevented");
            ok(guardFormErrorTriggered, "guardFormError is still triggered");
          });

          test("guard form error can prevent default", function() {
            var guardErrorTriggered = false;
            $("#form1-1").bind("guardError", function(e) { guardErrorTriggered = true; });
            $("#form1").bind("guardFormError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1-1").using("required");
            $("#form1").guard();
            equal($(":has-error").size(), 0, "Errors after default prevented");
            ok(guardErrorTriggered, "guardError is still triggered");
          });

          test("grouped guard form error can prevent default", function() {
            var guardErrorTriggered = false;
            $("#form1-1").bind("guardError", function(e) { guardErrorTriggered = true; });
            $("#form1").bind("guardFormError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            equal($(":has-error").size(), 0, "Errors after default prevented");
            ok(guardErrorTriggered, "guardError is still triggered");
          });

          test("guard error event", function() {
            var event, self;
            $("#form1-1").bind("guardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
          });

          test("grouped guard error event", function() {
            var event, self;
            $("#form1-1").bind("guardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
          });

          test("guard form error event", function() {
            var event, self;
            $("form").bind("guardFormError", function(e) {
              if ($(e.errorElements).is("#form1-1")) {
                self = this;
                event = e;
              }
            });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
          });

          test("grouped guard form error event", function() {
            var event, self;
            $("form").bind("guardFormError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
          });

          test("after guard error event", function() {
            var event, self;
            $("#form1-1").bind("afterGuardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          test("after grouped guard error event", function() {
            var event, self;
            $("#form1-1").bind("afterGuardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          test("after guard form error event", function() {
            var event, self;
            $("form").bind("afterGuardFormError", function(e) {
              if ($(e.errorElements).is("#form1-1")) {
                self = this;
                event = e;
              }
            });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          test("after grouped guard form error event", function() {
            var event, self;
            $("form").bind("afterGuardFormError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          test("clear guard error", function() {
            var events = [];
            $("form input").bind("clearGuardError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 3, "Number of events fired");
          });

          test("clear grouped guard error", function() {
            var events = [];
            $("form input").bind("clearGuardError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 3, "Number of events fired");
          });

          test("clear guard form error", function() {
            var events = [];
            $("form").bind("clearGuardFormError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 3, "Number of events fired");
          });

          test("clear grouped guard form error", function() {
            var events = [];
            $("form").bind("clearGuardFormError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 1, "Number of events fired");
          });

          test("after clear guard error", function() {
            var events = [];
            $("form input").bind("afterClearGuardError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 3, "Number of events fired");
          });

          test("after clear grouped guard error", function() {
            var events = [];
            $("form input").bind("afterClearGuardError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 3, "Number of events fired");
          });

          test("after clear guard form error", function() {
            var events = [];
            $("form").bind("afterClearGuardFormError", function(e) { events.push(e); });
            $.guard("#form1 input").using("required");
            $.guard("#form1-3").using("email");
            $("#form1-2").val("Something");
            $("#form1-3").val("Not an email");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 3, "Number of events fired");
          });

          test("after grouped guard form error", function() {
            var events = [];
            $("form").bind("afterClearGuardFormError", function(e) { events.push(e); });
            $.guard("#form1-1,#form1-2,#form1-3").using("oneRequired");
            $("#form1").guard();
            equal(events.length, 0, "Number of events fired");
            $("#form1 input").clearErrors();
            equal(events.length, 1, "Number of events fired");
          });

          test("clear guard error can prevent default", function() {
            var clearGuardFormErrorTriggered = false;
            $("#form1").bind("clearGuardFormError", function(e) { clearGuardFormErrorTriggered = true; });
            $("#form1-1").bind("clearGuardError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1-1").using("required");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal($(":has-error").size(), 1, "Errors after default prevented");
            ok(clearGuardFormErrorTriggered, "clearGuardFormError is still triggered");
          });

          test("clear grouped guard error can prevent default", function() {
            var clearGuardFormErrorTriggered = false;
            $("#form1").bind("clearGuardFormError", function(e) { clearGuardFormErrorTriggered = true; });
            $("#form1-1").bind("clearGuardError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal($(":has-error").size(), 4, "Errors after default prevented");
            ok(clearGuardFormErrorTriggered, "clearGuardFormError is still triggered");
          });

          test("clear guard form error can prevent default", function() {
            var clearGuardErrorTriggered = false;
            $("#form1-1").bind("clearGuardError", function(e) { clearGuardErrorTriggered = true; });
            $("#form1").bind("clearGuardFormError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1-1").using("required");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal($(":has-error").size(), 1, "Errors after default prevented");
            ok(clearGuardErrorTriggered, "clearGuardError is still triggered");
          });

          test("clear grouped guard form error can prevent default", function() {
            var clearGuardErrorTriggered = false;
            $("#form1-1").bind("clearGuardError", function(e) { clearGuardErrorTriggered = true; });
            $("#form1").bind("clearGuardFormError", function(e) { e.preventDefault(); });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal($(":has-error").size(), 4, "Errors after default prevented");
            ok(clearGuardErrorTriggered, "clearGuardError is still triggered");
          });

          test("clear guard error event", function() {
            var event, self;
            $("#form1-1").bind("clearGuardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
          });

          test("clear grouped guard error event", function() {
            var event, self;
            $("#form1-1").bind("clearGuardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
          });

          test("clear guard form error event", function() {
            var event, self;
            $("form").bind("clearGuardFormError", function(e) {
              if ($(e.errorElements).is("#form1-1")) {
                self = this;
                event = e;
              }
            });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
          });

          test("clear grouped guard form error event", function() {
            var event, self;
            $("form").bind("clearGuardFormError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
          });

          test("after clear guard error event", function() {
            var event, self;
            $("#form1-1").bind("afterClearGuardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          test("after clear grouped guard error event", function() {
            var event, self;
            $("#form1-1").bind("afterClearGuardError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1-1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          test("after clear guard form error event", function() {
            var event, self;
            $("form").bind("afterClearGuardFormError", function(e) {
              if ($(e.errorElements).is("#form1-1")) {
                self = this;
                event = e;
              }
            });
            var guard = $.guard("#form1 input").using("required");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, [$("#form1-1")[0]], "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          test("after clear grouped guard form error event", function() {
            var event, self;
            $("form").bind("afterClearGuardFormError", function(e) { self = this; event = e; });
            var guard = $.guard("#form1 input").using("oneRequired");
            $("#form1").guard();
            $("#form1 input").clearErrors();
            equal(self, $("#form1")[0], "Event context");
            equal(event.guard, guard, "Event guard");
            equalArray(event.errorElements, $("#form1 input").toArray(), "Event error elements");
            equal(event.errorMessage, $("#form1 .error-message")[0], "Event error message element");
          });

          module("live guards", { setup: resetGuards });

          test("stacked errors won't double up with live guards", function() {
            $.guard("input").using("required");
            $.guard("input").using("required").message("Other error");
            $.guards.options.stackErrors = true;
            $.liveGuard("#form1");
            $("#form1-1").blur();
            equal($("#form1-1").errors().length, 2, "There are 2 errors after first blur");
            equal($("#form1 .error-message").size(), 2, "There are 2 error messages after first blur");
            $("#form1-1").blur();
            equal($("#form1-1").errors().length, 2, "There are 2 errors after second blur");
            equal($("#form1 .error-message").size(), 2, "There are 2 error messages after first blur");
            $("#form1 :has-error").clearErrors();
            $.disableLiveGuard("#form1");
          });

          test("live guards can be removed", function() {
            $.guard("input").using("required");
            $("#form1-1").blur();
            equal($("#form1 :has-error").size(), 0, "Errors after blurring");
            $.liveGuard("#form1");
            $("#form1-1").blur();
            equal($("#form1 :has-error").size(), 1, "Errors after blurring");
            $("#form1 :has-error").clearErrors();
            $.disableLiveGuard("#form1");
            $("#form1-1").blur();
            equal($("#form1 :has-error").size(), 0, "Errors after blurring");
          });

          test("live guard onblur will clear error if it passes", function() {
            var pass = false;
            $.guard("#form1 input").using(function() { return pass; });
            $.liveGuard("#form1");
            equal($("#form1 :has-error").size(), 0, "Errors before blurring");
            $("#form1 input").blur();
            equal($("#form1 :has-error").size(), 4, "Errors after blurring everything");
            pass = true;
            $("#form1-1").blur();
            equal($("#form1 :has-error").size(), 3, "Errors after blurring when error should no longer happen");
            ok($("#form1-1:has-error").size() === 0, "Blurred field no longer has an error");
          });

          test("live guard onblur will clear grouped errors if it passes", function() {
            var pass = false;
            $.guard("#form1 input").grouped().using(function() { return pass; });
            $.liveGuard("#form1");
            equal($("#form1 :has-error").size(), 0, "Errors before blurring");
            $("#form1 input").blur();
            equal($("#form1 :has-error").size(), 4, "Errors after blurring everything");
            pass = true;
            $("#form1-1").blur();
            equal($("#form1 :has-error").size(), 0, "Errors after blurring when error should no longer happen");
            ok($("#form1-1:has-error").size() === 0, "Blurred field no longer has an error");
          });

          module("radio buttons", { setup: function() {
            resetGuards();
            $.guard("input").using("required");
          } });

          test("another form's radio state with same name doesn't affect the results", function() {
            $("#form4-2,#form4-5").attr("checked", "checked");
            assertGuards({
              form: "#form2",
              expectedToPass: false,
              expectedErrorCount: 5,
              expectedErrorMessageCount: 2,
              errorMessageLocations: $("#form2-3,#form2-5"),
              errorMessages: "This field is required."
            });
          });

          test("with all groups invalid", function() {
            assertGuards({
              form: "#form2",
              expectedToPass: false,
              expectedErrorCount: 5,
              expectedErrorMessageCount: 2,
              errorMessageLocations: $("#form2-3,#form2-5"),
              errorMessages: "This field is required."
            });
          });

          test("with the first group invalid", function() {
            $("#form2-4").attr("checked", "checked");
            assertGuards({
              form: "#form2",
              expectedToPass: false,
              expectedErrorCount: 3,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form2-3"),
              errorMessages: "This field is required."
            });
          });

          test("with none invalid", function() {
            $("#form2-1,#form2-4").attr("checked", "checked");
            assertGuards({
              form: "#form2",
              expectedToPass: true
            });
          });

          test("have the errors placed after the nextSibling (where there is expected to be text)", function() {
            $("#form2").guard();
            equal($("#form2-3")[0].nextSibling.nextSibling, $("#form2-3").next("." + errorMsgClass())[0], "Error location");
          });

          module("chekboxes", { setup: function() {
            resetGuards();
            $.guard("input").using("required");
          } });

          test("with all boxes invalid", function() {
            assertGuards({
              form: "#form3",
              expectedToPass: false,
              expectedErrorCount: 3,
              expectedErrorMessageCount: 3,
              errorMessageLocations: $("#form3 input"),
              errorMessages: "This field is required."
            });
          });

          test("with the second box invalid", function() {
            $("#form3-2").attr("checked", "checked");
            assertGuards({
              form: "#form3",
              expectedToPass: false,
              expectedErrorCount: 2,
              expectedErrorMessageCount: 2,
              errorMessageLocations: $("#form3 input[id!='form3-2']"),
              errorMessages: "This field is required."
            });
          });

          test("with none invalid", function() {
            $("#form3 input").attr("checked", "checked");
            assertGuards({
              form: "#form3",
              expectedToPass: true
            });
          });

          test("have the errors placed after the nextSibling (where there is expected to be text)", function() {
            $("#form3").guard();
            equal($("#form3-1")[0].nextSibling.nextSibling, $("#form3-1").next("." + errorMsgClass())[0], "Error location");
          });

          module("forms with mixed radio buttons/checkboxes and other inputs", { setup: function() {
            resetGuards();
            $.guard("input").using("required").grouped();
          } });

          test("radio buttons have the errors placed after the last element when it isn't a radio button", function() {
            $("#form4").guard();
            equal($("#form4-7")[0].nextSibling, $("#form4 ." + errorMsgClass())[0], "Error location");
          });

          test("radio buttons have the errors placed after the nextSibling when the last element is a radio button", function() {
            $("#form5").guard();
            equal($("#form5-6")[0].nextSibling.nextSibling, $("#form5 ." + errorMsgClass())[0], "Error location");
          });

          test("checkboxes have the errors placed after the last element when it isn't a checkbox", function() {
            $("#form6").guard();
            equal($("#form6-5")[0].nextSibling, $("#form6 ." + errorMsgClass())[0], "Error location");
          });

          test("checkboxes have the errors placed after the nextSibling when the last element is a checkbox", function() {
            $("#form7").guard();
            equal($("#form7-4")[0].nextSibling.nextSibling, $("#form7 ." + errorMsgClass())[0], "Error location");
          });

          module("styling guards", { setup: resetGuards });

          test("no arguments", function() {
            var $style = $($.guards.styleHtml());
            ok($style.is("style"), "Creates a style element");
            okStyle(".invalid-field", "background-color", "#ffff66", $style.html());
            okStyle(".error-message", "color", "#ff0000", $style.html());
            okStyle(".error-message", "margin-left", "10px", $style.html());
          });

          test("customized field style", function() {
            var $style = $($.guards.styleHtml({ field: { color: "#00ff00" } }));
            notOkStyle(".invalid-field", "background-color", "#ffff66", $style.html());
            okStyle(".invalid-field", "color", "#00ff00", $style.html());
            okStyle(".error-message", "color", "#ff0000", $style.html());
            okStyle(".error-message", "margin-left", "10px", $style.html());
          });

          test("customized message style", function() {
            var $style = $($.guards.styleHtml({ message: { "background-color": "#0000ff" } }));
            okStyle(".invalid-field", "background-color", "#ffff66", $style.html());
            notOkStyle(".error-message", "color", "#ff0000", $style.html());
            notOkStyle(".error-message", "margin-left", "10px", $style.html());
            okStyle(".error-message", "background-color", "#0000ff", $style.html());
          });

          test("customized field and message style", function() {
            var $style = $($.guards.styleHtml({ field: { color: "#00ff00" }, message: { "background-color": "#0000ff" } }));
            notOkStyle(".invalid-field", "background-color", "#ffff66", $style.html());
            okStyle(".invalid-field", "color", "#00ff00", $style.html());
            notOkStyle(".error-message", "color", "#ff0000", $style.html());
            notOkStyle(".error-message", "margin-left", "10px", $style.html());
            okStyle(".error-message", "background-color", "#0000ff", $style.html());
          });

          test("with selector scope", function() {
            var $style = $($.guards.styleHtml("#myForm"));
            okStyle("#myForm .invalid-field", "background-color", "#ffff66", $style.html());
            okStyle("#myForm .error-message", "color", "#ff0000", $style.html());
            okStyle("#myForm .error-message", "margin-left", "10px", $style.html());
          });

          test("with selector scope and customized style", function() {
            var $style = $($.guards.styleHtml("#myForm", { field: { color: "#00ff00" }, message: { "background-color": "#0000ff" } }));
            notOkStyle("#myForm .invalid-field", "background-color", "#ffff66", $style.html());
            okStyle("#myForm .invalid-field", "color", "#00ff00", $style.html());
            notOkStyle("#myForm .error-message", "color", "#ff0000", $style.html());
            notOkStyle("#myForm .error-message", "margin-left", "10px", $style.html());
            okStyle("#myForm .error-message", "background-color", "#0000ff", $style.html());
          });

          test("using different default message and error classes", function() {
            $.guards.defaults.invalidClass = "my-invalid";
            $.guards.defaults.messageClass = "my-error-message";
            var $style = $($.guards.styleHtml());
            notOkStyle(".invalid-field", "background-color", "#ffff66", $style.html());
            okStyle(".my-invalid", "background-color", "#ffff66", $style.html());
            notOkStyle(".error-message", "color", "#ff0000", $style.html());
            notOkStyle(".error-message", "margin-left", "10px", $style.html());
            okStyle(".my-error-message", "color", "#ff0000", $style.html());
            okStyle(".my-error-message", "margin-left", "10px", $style.html());
          });

          test("using different default message and error classes with selector scope and custom styles", function() {
            $.guards.defaults.invalidClass = "my-invalid";
            $.guards.defaults.messageClass = "my-error-message";
            var $style = $($.guards.styleHtml("#myForm", { field: { color: "#00ff00" }, message: { "background-color": "#0000ff" } }));
            notOkStyle("#myForm .invalid-field", "background-color", "#ffff66", $style.html());
            okStyle("#myForm .my-invalid", "color", "#00ff00", $style.html());
            notOkStyle("#myForm .error-message", "color", "#ff0000", $style.html());
            notOkStyle("#myForm .error-message", "margin-left", "10px", $style.html());
            okStyle("#myForm .my-error-message", "background-color", "#0000ff", $style.html());
          });

          module("data attribute guards", { setup: resetGuards, teardown: function() {
            $("form.data").remove();
          } });

          test("simple data based form can trigger errors", function() {
            $("body").append(
              '<form class="data" data-guarded>' +
              '  <input type="text" data-guard="required" />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 1,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("form.data input"),
              errorMessages: "This field is required."
            });
          });

          test("live guarded form can trigger errors", function() {
            $("body").append(
              '<form class="data" data-live-guarded>' +
              '  <input type="text" data-guard="required" />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 1,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("form.data input"),
              errorMessages: "This field is required."
            });
          });

          test("field guarded with options", function() {
            $("body").append(
              '<form class="data" data-guarded>' +
              '  <input type="text" value="2.0" data-guard="float" data-guard-float-min="42" />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 1,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("form.data input"),
              errorMessages: "Please enter a number no less than 42."
            });
          });

          test("field guarded with custom error message", function() {
            $("body").append(
              '<form class="data" data-guarded>' +
              '  <input type="text" value="2.0" data-guard="float" data-guard-float-min="42" data-guard-float-message="This is an error!" />' +
              '  <input type="text" value="" data-guard="float required" data-guard-float-message="Error!" />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 2,
              expectedErrorMessageCount: 2,
              errorMessageLocations: $("form.data input"),
              errorMessages: ["This is an error!",
                              "This field is required."]
            });
          });

          test("customized error message at form", function() {
            $("body").append(
              '<form class="data" data-guarded data-guard-float-message="This is an error!">' +
              '  <input type="text" value="2.0" data-guard="float" data-guard-float-min="42" />' +
              '  <input type="text" value="2.0" data-guard="float" data-guard-float-min="42" data-guard-float-message="This supercedes form error message!" />' +
              '  <input type="text" value="" data-guard="float required" />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 3,
              expectedErrorMessageCount: 3,
              errorMessageLocations: $("form.data input"),
              errorMessages: ["This is an error!",
                              "This supercedes form error message!",
                              "This field is required."]
            });
          });

          test("regex based data attribute guard", function() {
            $("body").append(
              '<form class="data" data-guarded>' +
              '  <input type="text" value="foo" data-guard="regex" data-guard-regex-pattern="bar" />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 1,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("form.data input"),
              errorMessages: "Please enter valid input."
            });

            $("form.data input").val("bar");
            assertGuards({
              form: "form.data",
              expectedToPass: true
            });
          });

          test("allowed based data attribute guard", function() {
            $("body").append(
              '<form class="data" data-guarded>' +
              '  <input type="text" value="foo" data-guard="allow" data-guard-allow-words="bar baz" />' +
              '  <input type="text" value="foo" data-guard="allow" data-guard-allow-words="bar,baz" data-guard-allow-delimiter="," />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 2,
              expectedErrorMessageCount: 2,
              errorMessageLocations: $("form.data input"),
              errorMessages: ["Please enter one of: bar, baz.",
                              "Please enter one of: bar, baz."]
            });

            $("form.data input").val("bar");
            assertGuards({
              form: "form.data",
              expectedToPass: true
            });
          });

          test("disallowed based data attribute guard", function() {
            $("body").append(
              '<form class="data" data-guarded>' +
              '  <input type="text" value="foo" data-guard="disallow" data-guard-disallow-words="foo bar" />' +
              '  <input type="text" value="foo" data-guard="disallow" data-guard-disallow-words="foo,bar" data-guard-disallow-delimiter="," />' +
              '</form>');
            assertGuards({
              form: "form.data",
              expectedToPass: false,
              expectedErrorCount: 2,
              expectedErrorMessageCount: 2,
              errorMessageLocations: $("form.data input"),
              errorMessages: ["Please don't enter: foo, bar.",
                              "Please don't enter: foo, bar."]
            });

            $("form.data input").val("baz");
            assertGuards({
              form: "form.data",
              expectedToPass: true
            });
          });

          module("custom guard", { setup: resetGuards });

          function customGuard(value, element) {
            return $.inArray(value, ["bad", "invalid"]) == -1;
          }

          test("custom guard that throws an exception causes guard to fail", function() {
            $.guard("input").using(function() { throw new Error("This guard always fails."); });
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: 4,
              expectedErrorMessageCount: 4,
              errorMessageLocations: $("#form1 input"),
              errorMessages: "Please fix this field."
            });
          });

          test("custom grouped guard that throws an exception causes guard to fail", function() {
            $.guard("input").grouped().using(function() { throw new Error("This guard always fails."); });
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: 4,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form1 input:last"),
              errorMessages: "Please fix this field."
            });
          });

          test("with custom function and no error message defined", function() {
            resetGuards();
            $.guard("input").using(customGuard);
            $("#form1-3").val("bad");
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: 1,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form1-3"),
              errorMessages: "Please fix this field."
            });
          });

          test("with custom function and an error message defined", function() {
            resetGuards();
            $.guard("input").using(customGuard).message("Custom error!");
            $("#form1-3").val("bad");
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: 1,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form1-3"),
              errorMessages: "Custom error!"
            });
          });

          test("with custom function and an error tag defined", function() {
            resetGuards();
            $.guard("input").using(customGuard).tag("p").message("Custom error!");
            $.guard("input").using("required");
            $("#form1-3,#form1-2").val("bad");
            $("#form1").guard();
            equal($("." + errorMsgClass()).size(), $("#form1 input").size(), "Total error count");
            equal($("p." + errorMsgClass()).size(), 2, "Error count with the custom tag");
            equal($(errorTag() + "." + errorMsgClass()).size(), 2, "Error count with the default tag");
          });

          test("with an error target defined", function() {
            resetGuards();
            $.guard("input").using("required").target("#form1-customTarget");
            $("#form1-3").val("value");
            $("#form1").guard();
            equal($("#form1-customTarget ." + errorMsgClass()).size(), $("#form1 input").size() - 1, "Custom target error count");
          });

          test("with an error target defined via a function", function() {
            resetGuards();
            $.guard("input").using("required").target(function() { return $(this).nextAll(".custom-target:eq(1)"); });
            $("#form1-3").val("value");
            $("#form1").guard();
            equal($("#form1-customTarget-2 ." + errorMsgClass()).size(), $("#form1 input").size() - 1, "Custom target error count");
          });

          test("with an error target defined via a function that inserts the error element itself", function() {
            resetGuards();
            $.guard("#form1-4").using("required").target(function(errorElement) {
              errorElement.appendTo($(".custom-target:eq(1)"));
              return false;
            }).message("My error message.");
            $("#form1").guard();
            equal($("#form1-customTarget-before-2 ." + errorMsgClass()).size(), 1, "Custom target error count");
            equal($("#form1-customTarget-before-2").text(), "My error message.", "Error message should not be duplicated.");
          });

          test("with a selector that doesn't select anything", function() {
            resetGuards();
            $.guard(".nothing").using("required");
            $("#form1").guard();
            equal($("input:has-error").size(), 0, "Error count");
          });

          test("with a custom invalid field class", function() {
            resetGuards();
            $.guard("#form1-1").using("required").invalidClass("my-error");
            $("#form1").guard();
            ok($("#form1-1").hasClass("my-error"), "Error field has custom input class");
            ok(!$("#form1-1").hasClass(invalidClass()), "Error field doesn't have default input class");
          });

          module("oneRequired guard", { setup: function() {
            resetGuards();
            $.guard("input").using("oneRequired");
          } });

          test("with nothing entered", function() {
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: $("#form1 input").size(),
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form1 input:last"),
              errorMessages: "Specify at least one."
            });
          });

          test("with one input entered", function() {
            $("#form1-3").val("A value");
            assertGuards({
              form: "#form1",
              expectedToPass: true
            });
          });

          test("with each input entered", function() {
            $("#form1 input").val("A value");
            assertGuards({
              form: "#form1",
              expectedToPass: true
            });
          });

          module("required guard", { setup: function() {
            resetGuards();
            $.guard("input").using("required");
          } });

          test("with nothing entered", function() {
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: $("#form1 input").size(),
              expectedErrorMessageCount: $("#form1 input").size(),
              errorMessageLocations: $("#form1 input"),
              errorMessages: "This field is required."
            });
          });

          test("with one input entered", function() {
            $("#form1-3").val("A value");
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: $("#form1 input").size() - 1,
              expectedErrorMessageCount: $("#form1 input").size() - 1,
              errorMessageLocations: $("#form1 input[id!='form1-3']"),
              errorMessages: "This field is required."
            });
          });

          test("with 3 inputs entered", function() {
            $("#form1-1,#form1-3,#form1-4").val("A value");
            assertGuards({
              form: "#form1",
              expectedToPass: false,
              expectedErrorCount: 1,
              expectedErrorMessageCount: 1,
              errorMessageLocations: $("#form1-2"),
              errorMessages: "This field is required."
            });
          });

          test("with each input entered", function() {
            $("#form1 input").val("A value");
            assertGuards({
              form: "#form1",
              expectedToPass: true
            });
          });

          module("email guard", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("email");
          } });

          successTest("");

          failureTest("aaa", {
            errorMessages: "Please enter a valid email address."
          });

          failureTest("aaa@bbb", {
            errorMessages: "Please enter a valid email address."
          });

          successTest("aaa@bbb.com");

          module("display email guard", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("email", { allowDisplay: true });
          } });

          successTest("");

          failureTest("aaa", {
            errorMessages: "Please enter a valid email address."
          });

          failureTest("aaa@bbb", {
            errorMessages: "Please enter a valid email address."
          });

          successTest("aaa@bbb.com");
          successTest("<aaa@bbb.com>");
          successTest("John Doe <aaa@bbb.com>");

          module("phoneUS guard", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("phoneUS");
          } });

          successTest("");

          failureTest("aaa", {
            errorMessages: "Please enter a valid phone number."
          });

          failureTest("123", {
            errorMessages: "Please enter a valid phone number."
          });

          failureTest("555-2345", {
            errorMessages: "Please enter a valid phone number."
          });

          successTest("408 555-2345");
          successTest("408-555-2345");
          successTest("(408) 555-2345");
          successTest("4085552345");
          successTest("14085552345");
          successTest("1-408-555-2345");
          successTest("1 (408) 555-2345");

          module("regex guard", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("regex", /^abc\d{1,3}$/);
          } });

          successTest("");

          failureTest("  ", {
            errorMessages: "Please enter valid input."
          });

          failureTest("xyz123", {
            errorMessages: "Please enter valid input."
          });

          failureTest("abc1234", {
            errorMessages: "Please enter valid input."
          });

          failureTest("blah abc123", {
            errorMessages: "Please enter valid input."
          });

          successTest("abc1");
          successTest("abc12");
          successTest("abc123");
          successTest("abc987");

          module("int with min 1 max 4", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("int", { min: 1, max: 4 });
          } });

          failureTest("0", {
            errorMessages: "Please enter a number from 1 to 4."
          });

          failureTest("-2", {
            errorMessages: "Please enter a number from 1 to 4."
          });

          failureTest("5", {
            errorMessages: "Please enter a number from 1 to 4."
          });

          failureTest("aaa", {
            errorMessages: "Please enter a number from 1 to 4."
          });

          failureTest("2aaa", {
            errorMessages: "Please enter a number from 1 to 4."
          });

          successTest("1");
          successTest("4");
          successTest("3");

          module("int with min 1", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("int", { min: 1 });
          } });

          failureTest("0", {
            errorMessages: "Please enter a number no less than 1."
          });

          failureTest("-2", {
            errorMessages: "Please enter a number no less than 1."
          });

          failureTest("aaa", {
            errorMessages: "Please enter a number no less than 1."
          });

          failureTest("2aaa", {
            errorMessages: "Please enter a number no less than 1."
          });

          successTest("1");
          successTest("3");

          module("int with max 4", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("int", { max: 4 });
          } });

          failureTest("5", {
            errorMessages: "Please enter a number no greater than 4."
          });

          failureTest("aaa", {
            errorMessages: "Please enter a number no greater than 4."
          });

          failureTest("2aaa", {
            errorMessages: "Please enter a number no greater than 4."
          });

          successTest("0");
          successTest("-2");
          successTest("4");
          successTest("3");

          module("int with no min or max", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("int");
          } });

          failureTest("aaa", {
            errorMessages: "Please enter a number."
          });

          failureTest("2aaa", {
            errorMessages: "Please enter a number."
          });

          successTest("-2");
          successTest("3");

          module("string with min 2 max 5", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("string", { min: 2, max: 5 });
          } });

          failureTest("", {
            errorMessages: "Please enter a string with length 2 to 5."
          });

          failureTest("   ", {
            errorMessages: "Please enter a string with length 2 to 5."
          });

          failureTest("a", {
            errorMessages: "Please enter a string with length 2 to 5."
          });

          failureTest("abcdef", {
            errorMessages: "Please enter a string with length 2 to 5."
          });

          successTest("ab");
          successTest("abcde");
          successTest("abc");
          successTest("  abc  ");

          module("string with min 2", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("string", { min: 2 });
          } });

          failureTest("", {
            errorMessages: "Please enter a string with length at least 2."
          });

          failureTest("   ", {
            errorMessages: "Please enter a string with length at least 2."
          });

          failureTest("a", {
            errorMessages: "Please enter a string with length at least 2."
          });

          successTest("ab");
          successTest("abc");

          module("string with max 5", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("string", { max: 5 });
          } });

          failureTest("abcdef", {
            errorMessages: "Please enter a string with length no greater than 5."
          });

          successTest("");
          successTest("a");
          successTest("abc");
          successTest("  abc  ");
          successTest("abcde");

          module("allow with ['good', ' better', ' best ', 1, '2', '03']", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("allow", ["good", " better", " best ", 1, "2", "03"]);
          } });

          failureTest("bad", {
            errorMessages: "Please enter one of: good, better, best, 1, 2, 03."
          });

          failureTest("Good", {
            errorMessages: "Please enter one of: good, better, best, 1, 2, 03."
          });

          failureTest("01", {
            errorMessages: "Please enter one of: good, better, best, 1, 2, 03."
          });

          failureTest("02", {
            errorMessages: "Please enter one of: good, better, best, 1, 2, 03."
          });

          failureTest("3", {
            errorMessages: "Please enter one of: good, better, best, 1, 2, 03."
          });

          successTest("good");
          successTest("best");
          successTest("  best  ");
          successTest("1");
          successTest("2");
          successTest("03");

          module("disallow with ['bad', ' worse', ' worst ', 1, '2', '03']", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("disallow", ["bad", " worse", " worst ", 1, "2", "03"]);
          } });

          failureTest("bad", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          failureTest(" bad", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          failureTest("worse", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          failureTest("worst", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          failureTest("  worst  ", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          failureTest("1", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          failureTest("2", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          failureTest("03", {
            errorMessages: "Please don't enter: bad, worse, worst, 1, 2, 03."
          });

          successTest("good");
          successTest("");
          successTest("Bad");
          successTest("01");
          successTest("02");
          successTest("3");

          module("float with min 1.2 max 4", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("float", { min: 1.2, max: 4 });
          } });

          failureTest("0", {
            errorMessages: "Please enter a number from 1.2 to 4."
          });

          failureTest("1", {
            errorMessages: "Please enter a number from 1.2 to 4."
          });

          failureTest("-2", {
            errorMessages: "Please enter a number from 1.2 to 4."
          });

          failureTest("5", {
            errorMessages: "Please enter a number from 1.2 to 4."
          });

          failureTest("aaa", {
            errorMessages: "Please enter a number from 1.2 to 4."
          });

          failureTest("2aaa", {
            errorMessages: "Please enter a number from 1.2 to 4."
          });

          successTest("1.2");
          successTest("4");
          successTest("3");

          module("float with no min or max", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("float");
          } });

          failureTest("aaa", {
            errorMessages: "Please enter a number."
          });

          failureTest("2aaa", {
            errorMessages: "Please enter a number."
          });

          failureTest("-2.", {
            errorMessages: "Please enter a number."
          });

          failureTest("--1", {
            errorMessages: "Please enter a number."
          });

          failureTest("0+.2", {
            errorMessages: "Please enter a number."
          });

          successTest("1.2");
          successTest(".23");
          successTest("-1");
          successTest("-11.23");

          module("moneyUS with no min or max", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("moneyUS");
          } });

          failureTest("aaa", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("2aaa", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("-2.", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("--1", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("0+.2", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("1,12,34", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("1211,234", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("$-$112", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("112.340", {
            errorMessages: "Please enter a dollar amount."
          });

          failureTest("112.3401", {
            errorMessages: "Please enter a dollar amount."
          });

          successTest("");
          successTest("1,232.20");
          successTest("$10,231,232");
          successTest("1.20");
          successTest(".23");
          successTest("-1");
          successTest("-11.23");
          successTest("$1.23");
          successTest("$3");
          successTest("$.23");
          successTest("-$.23");
          successTest("$-1.23");

          module("moneyUS with min and max", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("moneyUS", { min: 12.50, max: 15 });
          } });

          failureTest("$12.49", {
            errorMessages: "Please enter a dollar amount from 12.50 to 15.00."
          });

          failureTest("$15.01", {
            errorMessages: "Please enter a dollar amount from 12.50 to 15.00."
          });

          successTest("");
          successTest("$12.50");
          successTest("$15.00");
          successTest("13");

          module("Using preconditions", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("required").precondition(function() {
              if ($("#form1-2").val() == "fail") {
                throw new Error("Precondition failed");
              }

              return $("#form1-2").val() != "abc";
            });
          } });

          successTest("", "abc", { testName: "with precondition unmet and guard unmet" });
          successTest("123", "abc", { testName: "with precondition unmet and guard met" });
          successTest("", "fail", { testName: "with precondition unmet due to exception and guard unmet" });
          successTest("123", "fail", { testName: "with precondition unmet due to exception and guard met" });

          failureTest("", "", {
            testName: "with precondition met and guard unmet",
            errorMessages: "This field is required."
          });

          successTest("123", "", { testName: "with precondition met and guard met" });

          module("always", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("always");
          } });

          failureTest("", {
            testName: "errors are as expected",
            errorMessages: "There was an error."
          });

          var neverGuard1, neverGuard2;

          module("never", { setup: function() {
            resetGuards();
            neverGuard1 = $.guard("#form1-1, #form1-2").using("never");
            neverGuard2 = $.guard("#form1-3, #form1-4").grouped().using("never").message("Grouped never message.").target("#form1-customTarget");
          } });

          successTest("");

          test("grouped errors are grouped as appropriate, non-grouped are not grouped", function() {
            neverGuard1.triggerError("#form1-1, #form1-2");
            neverGuard2.triggerError("#form1-3, #form1-4");
            equal($("#form1 input").errors().length, 4, "Error count after triggering the never guards");
            equal($("#form1 .error-message").size(), 3, "Error message count");
            equal($("#form1 .error-message:eq(0)").text(), "There was an error.", "First error message");
            equal($("#form1 .error-message:eq(1)").text(), "There was an error.", "Second error message");
            equal($("#form1 .error-message:eq(2)").text(), "Grouped never message.", "Third error message");
          });

          module("same", { setup: function() {
            resetGuards();
            $.guard("#form1-1, #form1-2").using("same");
            $.guard("#form1-3").using("same");
          } });

          successTest("", "", "");
          successTest("abc 123", "abc 123", "something");

          failureTest("abc 123", "321 cba", {
            expectedErrorCount: 2,
            errorMessageSelector: "#form1-2",
            errorMessages: "These values must all match."
          });

          failureTest("abc 123", "", {
            expectedErrorCount: 2,
            errorMessageSelector: "#form1-2",
            errorMessages: "These values must all match."
          });

          failureTest("", "abc 123", {
            expectedErrorCount: 2,
            errorMessageSelector: "#form1-2",
            errorMessages: "These values must all match."
          });

          module("different", { setup: function() {
            resetGuards();
            $.guard("#form1-1, #form1-2").using("different");
            $.guard("#form1-3").using("different");
          } });

          successTest("abc 123", "321 cba", "something");
          successTest("abc 123", "ABC 123", "");
          successTest("abc 123", " abc 123");
          successTest("", "abc 123");
          successTest("abc 123", "");
          successTest("constructor", "");
          successTest("toString", "");

          failureTest("", "", {
            expectedErrorCount: 2,
            errorMessageSelector: "#form1-2",
            errorMessages: "These values must all be different."
          });

          failureTest("abc 123", "abc 123", {
            expectedErrorCount: 2,
            errorMessageSelector: "#form1-2",
            errorMessages: "These values must all be different."
          });

          failureTest(" abc 123", " abc 123", {
            expectedErrorCount: 2,
            errorMessageSelector: "#form1-2",
            errorMessages: "These values must all be different."
          });

          module("date", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("dateUS");
          } });

          successTest("01/22/2013");
          successTest("4/5/2013");

          failureTest("June 1st, 2012", {
            errorMessages: "Please use: dd/mm/yyyy."
          });

          failureTest("1/1/13", {
            errorMessages: "Please use: dd/mm/yyyy."
          });

          failureTest("0/1/2013", {
            errorMessages: "Please use: dd/mm/yyyy."
          });

          failureTest("1/0/2013", {
            errorMessages: "Please use: dd/mm/yyyy."
          });

          failureTest("13/5/2013", {
            errorMessages: "Please use: dd/mm/yyyy."
          });

          failureTest("2/32/2013", {
            errorMessages: "Please use: dd/mm/yyyy."
          });

          module("time", { setup: function() {
            resetGuards();
            $.guard("#form1-1").using("timeUS");
          } });

          successTest("1:44 AM");
          successTest("12:02 PM");
          successTest("5:44 am");
          successTest("6:37 pm");
          successTest("6:00 pm");
          successTest("06:00 pm");

          failureTest("14:22 pm", {
            errorMessages: "Please use: hh:mm&nbsp;am/pm."
          });

          failureTest("00:22 am", {
            errorMessages: "Please use: hh:mm&nbsp;am/pm."
          });

          failureTest("4:60 pm", {
            errorMessages: "Please use: hh:mm&nbsp;am/pm."
          });

          failureTest("5:23 zz", {
            errorMessages: "Please use: hh:mm&nbsp;am/pm."
          });
        });
      }
    </script>
  </head>

  <body>
    <div id="qunit"></div>

    <div id="qunit-fixture">
      <form id="form1">
        <div id="form1-customTarget-before" class="custom-target"></div>
        <div id="form1-customTarget-before-2" class="custom-target"></div>
        <input id="form1-1" type="text" name="text[]" />
        <input id="form1-2" type="text" name="text[]" />
        <input id="form1-3" type="text" name="other" />
        <input id="form1-4" type="text" name="another" />
        <div id="form1-customTarget" class="custom-target"></div>
        <div id="form1-customTarget-2" class="custom-target"></div>
      </form>

      <form id="form2">
        <input id="form2-1" type="radio" name="group1" value="1" /> FirstOption 1
        <input id="form2-2" type="radio" name="group1" value="2" /> FirstOption 2
        <input id="form2-3" type="radio" name="group1" value="3" /> FirstOption 3
        <input id="form2-4" type="radio" name="group2" value="a" /> Second Option a
        <input id="form2-5" type="radio" name="group2" value="b" /> Second Option b
      </form>

      <form id="form3">
        <input id="form3-1" type="checkbox" name="box[]" value="1" /> Box 1
        <input id="form3-2" type="checkbox" name="box[]" value="2" /> Box 2
        <input id="form3-3" type="checkbox" name="other" value="3" /> Box 3
      </form>

      <form id="form4">
        <input id="form4-1" type="text" name="text" />
        <input id="form4-2" type="radio" name="group1" value="1" /> FirstOption 1
        <input id="form4-3" type="radio" name="group1" value="2" /> FirstOption 2
        <input id="form4-4" type="radio" name="group1" value="3" /> FirstOption 3
        <input id="form4-5" type="radio" name="group2" value="a" /> Second Option a
        <input id="form4-6" type="radio" name="group2" value="b" /> Second Option b
        <input id="form4-7" type="text" name="text" />
      </form>

      <form id="form5">
        <input id="form5-1" type="text" name="text" />
        <input id="form5-2" type="radio" name="group1" value="1" /> FirstOption 1
        <input id="form5-3" type="radio" name="group1" value="2" /> FirstOption 2
        <input id="form5-4" type="radio" name="group1" value="3" /> FirstOption 3
        <input id="form5-5" type="radio" name="group2" value="a" /> Second Option a
        <input id="form5-6" type="radio" name="group2" value="b" /> Second Option b
      </form>

      <form id="form6">
        <input id="form6-1" type="text" name="text" />
        <input id="form6-2" type="checkbox" name="box[]" value="1" /> Box 1
        <input id="form6-3" type="checkbox" name="box[]" value="2" /> Box 2
        <input id="form6-4" type="checkbox" name="other" value="3" /> Box 3
        <input id="form6-5" type="text" name="text" />
      </form>

      <form id="form7">
        <input id="form7-1" type="text" name="text" />
        <input id="form7-2" type="checkbox" name="box[]" value="1" /> Box 1
        <input id="form7-3" type="checkbox" name="box[]" value="2" /> Box 2
        <input id="form7-4" type="checkbox" name="other" value="3" /> Box 3
      </form>

      <!-- fields with no actual form -->
      <div id="form8">
        <input id="form8-1" type="text" name="text" />
        <input id="form8-2" type="text" name="grouped[]" />
        <input id="form8-3" type="text" name="grouped[]" />
        <input id="form8-4" type="text" name="other" />
        <input id="form8-5" type="radio" name="group1" value="1" /> FirstOption 1
        <input id="form8-6" type="radio" name="group1" value="2" /> FirstOption 2
        <input id="form8-7" type="radio" name="group1" value="3" /> FirstOption 3
      </div>

      <form id="form9">
        <input id="form9-1" type="button" value="My Button" />
        <button id="form9-2">My Other Button</button>
      </form>
    </div>
  </body>
</html>
